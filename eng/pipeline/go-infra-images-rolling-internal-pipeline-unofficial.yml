# Code generated by pipelineymlgen; DO NOT EDIT.
# Origin file: go-infra-images-rolling-internal.gen.yml

# Copyright (c) Microsoft Corporation.
# Use of this source code is governed by a BSD-style
# license that can be found in the LICENSE file.

# This pipeline builds and publishes Go infra images on a rolling basis.

# official: https://dev.azure.com/dnceng/internal/_build?definitionId=1170
# unofficial: https://dev.azure.com/dnceng/internal/_build?definitionId=1515

trigger: {}
pr: none
schedules: []
parameters:
  - name: sourceBuildPipelineRunId
    displayName: >
      The build ID of this pipeline to publish images from. Use the default value when building new images.

    type: string
    default: '$(Build.BuildId)'
  - name: publishRepoPrefix
    displayName: >
      Publish repo prefix to use when publishing images. Switch to "dev/" for an unofficial branch.

    type: string
    default: dev/
variables:
  - template: variables/common.yml
    parameters:
      sourceBuildPipelineRunId: ${{ parameters.sourceBuildPipelineRunId }}
resources:
  repositories:
    - repository: 1ESPipelineTemplates
      type: git
      name: 1ESPipelineTemplates/1ESPipelineTemplates
      ref: refs/tags/release
    - repository: VersionsRepo
      type: git
      name: microsoft-go-images-versions
      ref: ${{ variables['gitHubVersionsRepoInfo.branch'] }}
extends:
  template: v1/1ES.Unofficial.PipelineTemplate.yml@1ESPipelineTemplates
  parameters:
    sdl:
      sourceAnalysisPool:
        name: NetCore1ESPool-Internal
        image: 1es-windows-2022
        os: windows
      sourceRepositoriesToScan:
        include:
          - repository: VersionsRepo
      tsa:
        enabled: true
        configFile: $(SDLConfigFileDir)/tsa/tsaoptions.json
    stages:
      - template: /eng/common/templates/stages/setup-service-connections.yml@self
        parameters:
          pool:
            name: $(default1ESInternalPoolName)
            image: $(default1ESInternalPoolImage)
            os: linux
          serviceConnections:
            - name: $(internal-mirror.serviceConnectionName)
            - name: $(build.serviceConnectionName)
            - name: $(publish.serviceConnectionName)
            - name: $(marStatus.serviceConnectionName)
            - name: $(kusto.serviceConnectionName)
      - template: /eng/common/templates/stages/dotnet/publish-config-prod.yml@self
        parameters:
          sourceBuildPipelineRunId: ${{ parameters.sourceBuildPipelineRunId }}
          publishRepoPrefix: ${{ parameters.publishRepoPrefix }}
          stagesTemplate: /eng/common/templates/stages/dotnet/build-test-publish-repo.yml@self
          stagesTemplateParameters:
            sourceBuildPipelineRunId: ${{ parameters.sourceBuildPipelineRunId }}
            buildMatrixCustomBuildLegGroupArgs: --custom-build-leg-group build
            versionsRepoRef: VersionsRepo
            noCache: true
            customGenerateMatrixInitSteps:
              - template: /eng/pipeline/steps/set-public-source-branch-var.yml@self
            customBuildInitSteps:
              - template: /eng/pipeline/steps/set-imagebuilder-build-args-var.yml@self
              - template: /eng/pipeline/steps/set-public-source-branch-var.yml@self
            customPublishInitSteps:
              - template: /eng/pipeline/steps/set-public-source-branch-var.yml@self
              - pwsh: echo "##vso[task.setvariable variable=SDLConfigFileDir]$(SDLConfigFileMultiRepoDir)"
                displayName: 'Set SDLConfigFileDir for multi-checkout'
